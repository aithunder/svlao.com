<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Cập nhật thông tin văn bằng</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
</head>

<body>
  <div class="wrapper">
    <!-- topbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="javascript:void(0);">Cập nhật thông tin văn bằng</a>
        </div>
        <div class="collapse navbar-collapse" id="myNavbar">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="http://svlao.com">Trang chủ</a></li>
            <li><a href="/index.html">Tra cứu sinh viên</a></li>
            <li><a href="/new-student.html">Thêm thông tin sinh viên</a></li>
            <li><a href="/user.html">Quản lý người dùng</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- content -->
    <div class="container" style="margin-top: 100px;">
      <div class="row">
        <!-- them thong tin van bang -->
				<div class="col-lg-8 col-lg-offset-2">
					<div class="panel panel-info">
						<div class="panel-heading">Sửa thông tin văn bằng</div>

						<div class="panel-body">
							<form onsubmit="themThongTinBangCap(event)">
								<div class="form-group">
									<label for="masv">Mã sinh viên:</label>
									<input type="text" class="form-control" id="masv" readonly>
								</div>
								<div class="form-group">
									<label for="so-hieu-bang">Số hiệu bằng:</label>
									<input type="text" class="form-control" id="so-hieu-bang">
								</div>
								<div class="form-group">
									<label for="nam-tot-nghiep">Năm tốt nghiệp:</label>
									<input type="text" class="form-control" id="nam-tot-nghiep">
								</div>
								<div class="form-group">
									<label for="xep-loai">Xếp loại:</label>
									<input type="text" class="form-control" id="xep-loai">
								</div>
								<div class="form-group">
									<label for="hinh-thuc-dao-tao">Hình thức đào tạo:</label>
									<input type="text" class="form-control" id="hinh-thuc-dao-tao">
								</div>
								<div class="form-group">
									<label for="ngay-cap">Ngày cấp:</label>
									<input type="text" class="form-control" id="ngay-cap">
								</div>
								<button type="submit" class="btn btn-info">Lưu</button>
							</form>
						</div>
					</div>
				</div>

      </div>
    </div>

  </div>
</body>

<script src="js/web3.js"></script>
<script src="./js/server-url.js"></script>
<script src="js/sweetalert.min.js"></script>
<script>
  // global variable:
  var currentUser = "";
  var CONTRACT = null;
  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get('id');

  async function initWeb3() {
    // init web3 provider:
    if (typeof (web3) !== 'undefined') {
      web3 = new Web3(web3.currentProvider);

      let result = await ethereum.enable();
      let result2 = await fetch(SERVER_URL + '/certificate/owner');
      result2.json().then(owner => {
        if (result[0].toLowerCase() == owner.toLowerCase()) {
          currentUser = result[0];
          console.log(new Date().toLocaleString() + ' -> Use metamask as web3 provider');

          // check user address to logout:
          web3.currentProvider.publicConfigStore.on('update', result => {
            if (!result.selectedAddress)
              window.location = "/";
            else
              currentUser = result.selectedAddress;
          });
        }
        else {
          window.location = "/";
        }
      });

      // init contract:
      fetch(SERVER_URL + "/certificate/contract").then(response => {
        response.json().then(contract => {
          CONTRACT = new web3.eth.Contract(contract.ABI, contract.address.toLowerCase());
        });
      });
    }
    else {
      swal("Máy bạn chưa có Metamask, cài đặt Metamask để đăng nhập vào hệ thống")
        .then((value) => {
          window.open("https://metamask.io/", "_blank");
        });
    }
  }

	// them thong tin bang cap:
  function themThongTinBangCap(event) {
    event.preventDefault();

    let masv = $("#masv").val();
    let soHieuBang = $("#so-hieu-bang").val();
    let namTotNghiep = $("#nam-tot-nghiep").val();
    let xepLoai = $("#xep-loai").val();
    let hinhThucDaoTao = $("#hinh-thuc-dao-tao").val();
    let ngayCap = $("#ngay-cap").val();

    CONTRACT.methods.SuaThongBangTotNghiep(masv, soHieuBang, namTotNghiep, xepLoai, hinhThucDaoTao, ngayCap)
      .send({ from: currentUser })
      .on("confirmation", function () {
        // clear textbox:
        $("#masv").val("");
        $("#so-hieu-bang").val("");
        $("#nam-tot-nghiep").val("");
        $("#xep-loai").val("");
        $("#hinh-thuc-dao-tao").val("");
        $("#ngay-cap").val("");
				// notify to user:
        swal("Thành công", "", "success");
      });
  }

  // lay thong tin van bang:
  function getCertificate() {
    fetch(SERVER_URL + "/certificate/certificate?id=" + id)
      .then(response => {
        response.json()
          .then(result => {
            if (!result.thongTinBangTotNghiep.SoHieu) {
              alert("Mã sinh viên không tồn tại trong hệ thống");
              return;
            }
            $("#masv").val(id);

            $("#so-hieu-bang").val(result.thongTinBangTotNghiep.SoHieu || "Chưa cập nhật");
            $("#nam-tot-nghiep").val(result.thongTinBangTotNghiep.NamTotNghiep || "Chưa cập nhật");
            $("#xep-loai").val(result.thongTinBangTotNghiep.XepLoai || "Chưa cập nhật");
            $("#hinh-thuc-dao-tao").val(result.thongTinBangTotNghiep.HinhThucDaoTao || "Chưa cập nhật");
            $("#ngay-cap").val(result.thongTinBangTotNghiep.NgayCap || "Chưa cập nhật");
          });
      });
  }

  initWeb3();
  getCertificate();
</script>

</html>

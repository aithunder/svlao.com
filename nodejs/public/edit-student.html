<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Cập nhật thông tin sinh viên</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
</head>

<body>
  <div class="wrapper">
    <!-- topbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="javascript:void(0);">Cập nhật thông tin sinh viên</a>
        </div>
        <div class="collapse navbar-collapse" id="myNavbar">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="http://svlao.com">Trang chủ</a></li>
            <li><a href="/index.html">Tra cứu sinh viên</a></li>
            <li><a href="/new-student.html">Thêm thông tin sinh viên</a></li>
            <li><a href="/user.html">Quản lý người dùng</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- content -->
    <div class="container" style="margin-top: 100px;">
      <div class="row">
        <!-- them thong tin co ban -->
        <div class="col-lg-8 col-lg-offset-2">
          <div class="panel panel-info">
            <div class="panel-heading">Sửa Thông tin cơ bản</div>

            <div class="panel-body">
              <form onsubmit="themThongTinCoBan(event)">
                <div class="form-group">
                  <label for="student-masv">Mã sinh viên:</label>
                  <input type="text" class="form-control" id="co-ban-masv" readonly>
                </div>
                <div class="form-group">
                  <label for="student-masv">Họ và tên:</label>
                  <input type="text" class="form-control" id="co-ban-ho-ten">
                </div>
                <div class="form-group">
                  <label for="student-masv">Ngày sinh:</label>
                  <input type="text" class="form-control" id="co-ban-ngay-sinh">
                </div>
                <div class="form-group">
                  <label for="student-masv">Trường:</label>
                  <input type="text" class="form-control" id="co-ban-truong">
                </div>
                <button type="submit" class="btn btn-info">Lưu</button>
              </form>
            </div>
          </div>
        </div>

        <!-- them thong tin khoa hoc -->
        <div class="col-lg-8 col-lg-offset-2">
          <div class="panel panel-info">
            <div class="panel-heading">Sửa Thông tin khoá học</div>

            <div class="panel-body">
              <form onsubmit="themThongTinKhoaHoc(event)">
                <div class="form-group">
                  <label for="student-masv">Mã sinh viên:</label>
                  <input type="text" class="form-control" id="khoa-hoc-masv" readonly>
                </div>
                <div class="form-group">
                  <label for="student-masv">Cấp học:</label>
                  <select class="form-control" id="khoa-hoc-cap-hoc">
                    <option value="Học tiếng Việt">Học tiếng Việt</option>
                    <option value="Cao đẳng">Cao đẳng</option>
                    <option value="Đại học">Đại học</option>
                    <option value="Thạc sĩ">Thạc sĩ</option>
                    <option value="Tiến sĩ">Tiến sĩ</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="student-masv">Ngành:</label>
                  <input type="text" class="form-control" id="khoa-hoc-nganh">
                </div>
                <div class="form-group">
                  <label for="student-masv">Khoá học:</label>
                  <input type="text" class="form-control" id="khoa-hoc-khoa-hoc">
                </div>
                <div class="form-group">
                  <label for="student-masv">Loại học bổng:</label>
                  <input type="text" class="form-control" id="khoa-hoc-hoc-bong">
                </div>
                <div class="form-group">
                  <label for="student-masv">Năm nhập học:</label>
                  <input type="text" class="form-control" id="khoa-hoc-nam-nhap-hoc">
                </div>
                <div class="form-group">
                  <label for="student-masv">Năm kết thúc:</label>
                  <input type="text" class="form-control" id="khoa-hoc-nam-ket-thuc">
                </div>
                <button type="submit" class="btn btn-info">Lưu</button>
              </form>
            </div>
          </div>
        </div>

        <!-- them thong tin lien he -->
        <div class="col-lg-8 col-lg-offset-2">
          <div class="panel panel-info">
            <div class="panel-heading">Sửa Thông tin liên hệ</div>

            <div class="panel-body">
              <form onsubmit="themThongTinLienHe(event)">
                <div class="form-group">
                  <label for="student-masv">Mã sinh viên:</label>
                  <input type="text" class="form-control" id="lien-he-masv" readonly>
                </div>
                <div class="form-group">
                  <label for="student-masv">Điện thoại:</label>
                  <input type="text" class="form-control" id="lien-he-dien-thoai">
                </div>
                <div class="form-group">
                  <label for="student-masv">Email:</label>
                  <input type="text" class="form-control" id="lien-he-email">
                </div>
                <div class="form-group">
                  <label for="student-masv">Kí túc xá:</label>
                  <input type="text" class="form-control" id="lien-he-ki-tuc-xa">
                </div>
                <button type="submit" class="btn btn-info">Lưu</button>
              </form>
            </div>
          </div>
        </div>

        <!-- them thong tin khac -->
        <div class="col-lg-8 col-lg-offset-2">
          <div class="panel panel-info">
            <div class="panel-heading">Sửa Thông tin khác</div>

            <div class="panel-body">
              <form onsubmit="themThongTinKhac(event)">
                <div class="form-group">
                  <label for="student-masv">Mã sinh viên:</label>
                  <input type="text" class="form-control" id="khac-masv" readonly>
                </div>
                <div class="form-group">
                  <label for="student-masv">Công việc chính:</label>
                  <input type="text" class="form-control" id="khac-cong-viec">
                </div>
                <div class="form-group">
                  <label for="student-masv">Số thông tư Lào:</label>
                  <input type="text" class="form-control" id="khac-thong-tu-lao">
                </div>
                <div class="form-group">
                  <label for="student-masv">Số thông tư việt Nam:</label>
                  <input type="text" class="form-control" id="khac-thong-tu-vn">
                </div>
                <div class="form-group">
                  <label for="student-masv">Ghi chú:</label>
                  <input type="text" class="form-control" id="khac-ghi-chu">
                </div>
                <button type="submit" class="btn btn-info">Lưu</button>
              </form>
            </div>
          </div>
        </div>

        <!-- diem  -->
        <div class="col-lg-8 col-lg-offset-2">
          <div class="panel panel-info">
            <div class="panel-heading">Thêm kết quả học tập</div>

            <div class="panel-body">
              <form onsubmit="themKetQuaHocTap(event);">
                <div class="form-group">
                  <label for="diem-masv">Mã sinh viên:</label>
                  <input type="text" class="form-control" id="diem-masv" readonly>
                </div>
                <div class="form-group">
                  <label for="diem-nam-hoc">Môn học:</label>
                  <select class="form-control" id="diem-nam-hoc">
                    <option value="N1">Năm học thứ nhất</option>
                    <option value="N2">Năm học thứ hai</option>
                    <option value="N3">Năm học thứ ba</option>
                    <option value="N4">Năm học thứ tư</option>
                    <option value="N5">Năm học thứ năm</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="diem-diem">Điểm:</label>
                  <input type="number" class="form-control" id="diem-ket-qua">
                </div>
                <button type="submit" class="btn btn-info">Lưu</button>
              </form>
            </div>
          </div>
        </div>

        <!-- avatar  -->
        <div class="col-lg-8 col-lg-offset-2">
          <div class="panel panel-info">
            <div class="panel-heading">Thêm ảnh đại diện</div>

            <div class="panel-body">
              <form onsubmit="themAnhDaiDien(event);">
                <div class="form-group">
                  <label for="hinh-masv">Mã sinh viên:</label>
                  <input type="text" class="form-control" id="hinh-masv" readonly>
                </div>
                <div class="form-group">
                  <label>Hình ảnh:</label>
                  <input type="file" id="hinh-file" />
                </div>
                <button type="submit" class="btn btn-info">Lưu</button>
              </form>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</body>

<script src="js/web3.js"></script>
<script src="./js/server-url.js"></script>
<script src="js/sweetalert.min.js"></script>
<script>
  // global variable:
  var currentUser = "";
  var CONTRACT = null;
  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get('id');

  async function initWeb3() {
    // init web3 provider:
    if (typeof (web3) !== 'undefined') {
      web3 = new Web3(web3.currentProvider);

      let result = await ethereum.enable();
      let result2 = await fetch(SERVER_URL + '/student/owner');
      result2.json().then(owner => {
        if (result[0].toLowerCase() == owner.toLowerCase()) {
          currentUser = result[0];
          console.log(new Date().toLocaleString() + ' -> Use metamask as web3 provider');

          // check user address to logout:
          web3.currentProvider.publicConfigStore.on('update', result => {
            if (!result.selectedAddress)
              window.location = "/";
            else
              currentUser = result.selectedAddress;
          });
        }
        else {
          window.location = "/";
        }
      });

      // init contract:
      fetch(SERVER_URL + "/student/contract").then(response => {
        response.json().then(contract => {
          CONTRACT = new web3.eth.Contract(contract.ABI, contract.address.toLowerCase());
        });
      });
    }
    else {
      swal("Máy bạn chưa có Metamask, cài đặt Metamask để đăng nhập vào hệ thống")
        .then((value) => {
          window.open("https://metamask.io/", "_blank");
        });
    }
  }

  // them thong tin co ban:
  function themThongTinCoBan(event) {
    event.preventDefault();

    let id = $("#co-ban-masv").val();
    let name = $("#co-ban-ho-ten").val();
    let birth = $("#co-ban-ngay-sinh").val();
    let school = $("#co-ban-truong").val();

    CONTRACT.methods.SuaThongTinCoBan(id, name, birth, school)
      .send({ from: currentUser })
      .on("confirmation", function () {
        // clear textbox:
        $("#co-ban-masv").val("");
        $("#co-ban-ho-ten").val("");
        $("#co-ban-ngay-sinh").val("");
        $("#co-ban-truong").val("");
        // notify to user:
        swal("Thành công", "", "success");
      });
  }

  // them thong tin khoa hoc:
  function themThongTinKhoaHoc(event) {
    event.preventDefault();

    let id = $("#khoa-hoc-masv").val();
    let level = $("#khoa-hoc-cap-hoc").val();
    let major = $("#khoa-hoc-nganh").val();
    let course = $("#khoa-hoc-khoa-hoc").val();
    let scholarship = $("#khoa-hoc-hoc-bong").val();
    let admissionYear = $("#khoa-hoc-nam-nhap-hoc").val();
    let endYear = $("#khoa-hoc-nam-ket-thuc").val();

    CONTRACT.methods.SuaThongTinKhoaHoc(id, level, major, course, scholarship, admissionYear, endYear)
      .send({ from: currentUser })
      .on("confirmation", function () {
        // clear textbox:
        $("#khoa-hoc-masv").val();
        $("#khoa-hoc-nganh").val();
        $("#khoa-hoc-khoa-hoc").val();
        $("#khoa-hoc-hoc-bong").val();
        $("#khoa-hoc-nam-nhap-hoc").val();
        $("#khoa-hoc-nam-ket-thuc").val();
        // notify to user:
        swal("Thành công", "", "success");
      });
  }

  // them thong tin lien he:
  function themThongTinLienHe(event) {
    event.preventDefault();

    let id = $("#lien-he-masv").val();
    let phone = $("#lien-he-dien-thoai").val();
    let email = $("#lien-he-email").val();
    let domitory = $("#lien-he-ki-tuc-xa").val();

    CONTRACT.methods.SuaThongTinLienHe(id, phone, email, domitory)
      .send({ from: currentUser })
      .on("confirmation", function () {
        // clear textbox:
        $("#lien-he-masv").val();
        $("#lien-he-dien-thoai").val();
        $("#lien-he-email").val();
        $("#lien-he-ki-tuc-xa").val();
        // notify to user:
        swal("Thành công", "", "success");
      });
  }

  // them thong tin khac:
  function themThongTinKhac(event) {
    event.preventDefault();

    let id = $("#khac-masv").val();
    let job = $("#khac-cong-viec").val();
    let laosCircular = $("#khac-thong-tu-lao").val();
    let vnCircular = $("#khac-thong-tu-vn").val();
    let note = $("#khac-ghi-chu").val();

    CONTRACT.methods.SuaThongTinKhac(id, job, laosCircular, vnCircular, note)
      .send({ from: currentUser })
      .on("confirmation", function () {
        // clear textbox:
        $("#khac-masv").val();
        $("#khac-cong-viec").val();
        $("#khac-thong-tu-lao").val();
        $("#khac-thong-tu-vn").val();
        $("#khac-ghi-chu").val();
        // notify to user:
        swal("Thành công", "", "success");
      });
  }

  // them diem:
  function themKetQuaHocTap(event) {
    event.preventDefault();

    let id = $("#diem-masv").val();
    let yearId = $("#diem-nam-hoc option:selected").val();
    let year = $("#diem-nam-hoc option:selected").text();
    let result = $("#diem-ket-qua").val();

    CONTRACT.methods.SuaThongTinDiem(id, yearId, year, result)
      .send({ from: currentUser })
      .on("confirmation", function () {
        // clear textbox:
        $("#diem-masv").val();
        $("#diem-ket-qua").val();
        // notify to user:
        swal("Thành công", "", "success");
      });
  }

  // them hinh:
  async function themAnhDaiDien(event) {
    event.preventDefault();

    const formData = new FormData();
    const fileField = document.getElementById("hinh-file");

    formData.append('studentId', id);
    formData.append('image', fileField.files[0]);

    try {
      const response = await fetch(SERVER_URL + '/upload/student', {
        method: 'POST',
        body: formData
      });
      await response.json().then(imageName => {
        CONTRACT.methods.SuaHinhDaiDien(id, imageName.fileName)
          .send({ from: currentUser })
          .on("confirmation", function () {
            swal("Thành công", "", "success");
          });
      });
    } catch (error) {
      console.error('Error:', error);
    }
  }

  // lay thong tin sinh vien:
  function getStudent() {
    fetch(SERVER_URL + "/student/student?id=" + id)
      .then(response => {
        response.json()
          .then(result => {
            if (!result.thongTinCoBan.HoTen) {
              alert("Mã sinh viên không tồn tại trong hệ thống");
              return;
            }
            $("#co-ban-masv").val(id);
            $("#khoa-hoc-masv").val(id);
            $("#lien-he-masv").val(id);
            $("#khac-masv").val(id);
            $("#diem-masv").val(id);
            $("#hinh-masv").val(id);

            $("#co-ban-ho-ten").val(result.thongTinCoBan.HoTen || "Chưa cập nhật");
            $("#co-ban-ngay-sinh").val(result.thongTinCoBan.NgaySinh || "Chưa cập nhật");
            $("#co-ban-truong").val(result.thongTinCoBan.Truong || "Chưa cập nhật");
            $("#khoa-hoc-cap-hoc").val(result.thongTinKhoaHoc.CapHoc || "Chưa cập nhật");
            $("#khoa-hoc-nganh").val(result.thongTinKhoaHoc.Nganh || "Chưa cập nhật");
            $("#khoa-hoc-khoa-hoc").val(result.thongTinKhoaHoc.KhoaHoc || "Chưa cập nhật");
            $("#khoa-hoc-nam-nhap-hoc").val(result.thongTinKhoaHoc.NamNhapHoc || "Chưa cập nhật");
            $("#khoa-hoc-nam-ket-thuc").val(result.thongTinKhoaHoc.NamKetThuc || "Chưa cập nhật");
            $("#khoa-hoc-hoc-bong").val(result.thongTinKhoaHoc.LoaiHocBong || "Chưa cập nhật");
            $("#lien-he-ki-tuc-xa").val(result.thongTinLienHe.KiTucXa || "Chưa cập nhật");
            $("#lien-he-dien-thoai").val(result.thongTinLienHe.DienThoai || "Chưa cập nhật");
            $("#lien-he-email").val(result.thongTinLienHe.Email || "Chưa cập nhật");
            $("#khac-thong-tu-lao").val(result.thongTinKhac.ThongTuLao || "Chưa cập nhật");
            $("#khac-thong-tu-vn").val(result.thongTinKhac.ThongTuVN || "Chưa cập nhật");
            $("#khac-cong-viec").val(result.thongTinKhac.CongViecChinh || "Chưa cập nhật");
            $("#khac-ghi-chu").val(result.thongTinKhac.GhiChu || "Chưa cập nhật");
          });
      });
  }

  initWeb3();
  getStudent();
</script>

</html>

<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Tra cứu thông tin sinh viên</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<style>
  .panel {
    display: none;
  }

  .table {
    margin: 0;
  }
</style>

<body>
  <div class="wrapper">

    <!-- topbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="javascript:void(0);">Tra cứu thông tin sinh</a>
        </div>
        <div class="collapse navbar-collapse" id="myNavbar">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="http://svlao.com">Trang chủ</a></li>
            <li><a href="/certificate.html">Tra cứu văn bằng</a></li>
            <li><a href="http://svlao.com/?page_id=28">Liên hệ</a></li>
            <li><a id="link-login" onclick="login()" href="javascript:void(0);">Đăng nhập</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- main content -->
    <div class="content" style="margin-top: 100px;">
      <div class="container">
        <br>
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2">
            <form onsubmit="searchStudent(event);">
              <div class="input-group">
                <span class="input-group-addon">Mã sinh viên</span>
                <input id="masv" type="text" class="form-control" name="masv" placeholder="Nhập vào mã sinh viên">
                <span class="input-group-btn">
                  <button class="btn btn-default" type="submit">Tìm</button>
                </span>
              </div>
            </form>
          </div>
        </div>
        <br>
        <br>

        <div class="row">
          <div class="col-lg-6 col-lg-offset-1">
            <div class="panel panel-info">
              <div class="panel-heading">Thông tin sinh viên</div>
              <div class="panel-body" style="padding: 0;">
                <div class="table-responsive">
                  <table class="table">
                    <tbody>
                      <tr>
                        <td>Tên sinh viên</td>
                        <td id="co-ban-ho-ten">Tên sinh viên</td>
                      </tr>
                      <tr>
                        <td>Ngày sinh</td>
                        <td id="co-ban-ngay-sinh">Ngày sinh</td>
                      </tr>
                      <tr>
                        <td>Trường</td>
                        <td id="co-ban-truong">Trường</td>
                      </tr>
                      <tr>
                        <td>Cấp học</td>
                        <td id="khoa-hoc-cap-hoc">Cấp học</td>
                      </tr>
                      <tr>
                        <td>Ngành học</td>
                        <td id="khoa-hoc-nganh">Ngành học</td>
                      </tr>
                      <tr>
                        <td>Khóa học</td>
                        <td id="khoa-hoc-khoa-hoc">Khóa học</td>
                      </tr>
                      <tr>
                        <td>Số điện thoại</td>
                        <td id="lien-he-dien-thoai">Số điện thoại</td>
                      </tr>
                      <tr>
                        <td>Email</td>
                        <td id="lien-he-email">Email</td>
                      </tr>
                      <tr>
                        <td>Kí túc xá</td>
                        <td id="lien-he-ki-tuc-xa">Kí túc xá</td>
                      </tr>
                      <tr>
                        <td>Loại học bổng</td>
                        <td id="khoa-hoc-hoc-bong">Loại học bổng</td>
                      </tr>
                      <tr>
                        <td>Số thông tư bên Lào</td>
                        <td id="khac-thong-tu-lao">Số thông tư bên Lào</td>
                      </tr>
                      <tr>
                        <td>Số thông tư bên Việt Nam</td>
                        <td id="khac-thong-tu-vn">Số thông tư bên Việt Nam</td>
                      </tr>
                      <tr>
                        <td>Công việc chính thức</td>
                        <td id="khac-cong-viec">Công việc chính thức</td>
                      </tr>
                      <tr>
                        <td>Năm nhập học</td>
                        <td id="khoa-hoc-nam-nhap-hoc">Năm nhập học</td>
                      </tr>
                      <tr>
                        <td>Năm kết thúc</td>
                        <td id="khoa-hoc-nam-ket-thuc">Năm kết thúc</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4">
              <div class="panel panel-info">
                <div class="panel-heading">Hình ảnh</div>
                <div class="panel-body" style="padding: 0;">
                  <div class="table-responsive">
                    <table class="table">
                      <tbody>
                        <th style="text-align: center;">
                          <img id="student-avatar" width="200"
                            src="">
                        </th>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

          <div class="col-lg-4">
            <div class="panel panel-info">
              <div class="panel-heading">Kết quả học tập</div>
              <div class="panel-body" style="padding: 0;">
                <div class="table-responsive">
                  <table class="table" id="table-diem">
                    <tbody>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>
</body>

<script src="js/sweetalert.min.js"></script>
<script src="./js/server-url.js"></script>
<script src="./js/web3.js"></script>

<script>
  async function login() {
    if (typeof (web3) !== 'undefined') {
      web3 = new Web3(web3.currentProvider);
      let result = await ethereum.enable();
      let result2 = await fetch(SERVER_URL + '/student/owner');
      result2.json().then(owner => {
        if (result[0].toLowerCase() == owner.toLowerCase()) {
          window.location = "/list-student.html";
        }
        else {
          swal("Thông báo", "Địa chỉ ví đang đăng nhập không có quyền chỉnh sửa dữ liệu. Hãy kiểm tra lại địa chỉ ví đang chọn trong Metamask rồi nhấn lại nút đăng nhập", "error");
        }
      })
    }
    else {
      swal("Máy bạn chưa có Metamask, cài đặt Metamask để đăng nhập vào hệ thống")
        .then((value) => {
          window.open("https://metamask.io/", "_blank");
        });
    }
  }
</script>

<script>
  // function that unhide table when data is return from server:
  function showResult() {
    // show table result:
    var arrPanel = $(".panel");
    for (let i = 0; i < arrPanel.length; i++) {
      arrPanel[i].style.display = "block";
    }
  }

  function searchStudent(event) {
    event.preventDefault();
    fetch(SERVER_URL + "/student/student?id=" + $("#masv").val())
      .then(response => {
        response.json()
          .then(result => {
            if (!result.thongTinCoBan.HoTen) {
              alert("Mã sinh viên không tồn tại trong hệ thống");
              return;
            }
            // also find student mark if he/she existed:
            searchMark();
            if (response.status == 200) showResult();
            $("#co-ban-ho-ten").html(result.thongTinCoBan.HoTen || "Chưa cập nhật");
            $("#co-ban-ngay-sinh").html(result.thongTinCoBan.NgaySinh || "Chưa cập nhật");
            $("#co-ban-truong").html(result.thongTinCoBan.Truong || "Chưa cập nhật");
            $("#khoa-hoc-cap-hoc").html(result.thongTinKhoaHoc.CapHoc || "Chưa cập nhật");
            $("#khoa-hoc-nganh").html(result.thongTinKhoaHoc.Nganh || "Chưa cập nhật");
            $("#khoa-hoc-khoa-hoc").html(result.thongTinKhoaHoc.KhoaHoc || "Chưa cập nhật");
            $("#khoa-hoc-nam-nhap-hoc").html(result.thongTinKhoaHoc.NamNhapHoc || "Chưa cập nhật");
            $("#khoa-hoc-nam-ket-thuc").html(result.thongTinKhoaHoc.NamKetThuc || "Chưa cập nhật");
            $("#khoa-hoc-hoc-bong").html(result.thongTinKhoaHoc.LoaiHocBong || "Chưa cập nhật");
            $("#lien-he-ki-tuc-xa").html(result.thongTinLienHe.KiTucXa || "Chưa cập nhật");
            $("#lien-he-dien-thoai").html(result.thongTinLienHe.DienThoai || "Chưa cập nhật");
            $("#lien-he-email").html(result.thongTinLienHe.Email || "Chưa cập nhật");
            $("#khac-thong-tu-lao").html(result.thongTinKhac.SoThongTuLao || "Chưa cập nhật");
            $("#khac-thong-tu-vn").html(result.thongTinKhac.SoThongTuVN || "Chưa cập nhật");
            $("#khac-cong-viec").html(result.thongTinKhac.CongViecChinh || "Chưa cập nhật");
            $("#khac-ghi-chu").html(result.thongTinKhac.GhiChu || "Chưa cập nhật");
            if (result.hinhDaiDien)
            $("#student-avatar").attr("src", "/uploads/" + result.hinhDaiDien);
            else
            $("#student-avatar").attr("src", "https://www.koste.com.au/wp-content/uploads/2017/07/avatar-1577909_640-300x300.png");
          });
      });
  }

  function searchMark() {
    fetch(SERVER_URL + "/student/mark?id=" + $("#masv").val())
      .then(response => {
        response.json().then(subjects => {
          let content = "";
          subjects.forEach(subject => {
            content += `<tr>
                          <td>`+ subject.subjectName + `</td>
                          <td>`+ subject.value + `</td>
                        </tr>`;
          });
          $("#table-diem").find("tbody").html(content);
        });
      });
  }
</script>

</html>
